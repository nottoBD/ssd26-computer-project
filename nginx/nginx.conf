worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    # Prevents MIME type sniffing
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    # Increased for larger uploads
    client_max_body_size 100m;

    # Decreased for better security
    proxy_read_timeout 60;
    proxy_connect_timeout 60;
    proxy_send_timeout 60;

    # Rate limiting to prevent abuse
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=5r/s;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    upstream backend {
        server server:8000;
    }

    upstream frontend {
        server client:5173;
    }

    server {
        listen 443 ssl;
        server_name healthsecure.local localhost;

        ssl_certificate /etc/ssl/certs/ssl-chain.pem;
        ssl_certificate_key /etc/ssl/private/ssl-privatekey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers off;

        ssl_client_certificate /etc/ssl/certs/step-root.pem;
        ssl_verify_client optional;  # 'on' = Strict mTLS

        include /etc/nginx/snippets/upstream_headers.conf;

        # Access logging for monitoring and anomaly detection
        access_log /var/log/nginx/access.log combined;

        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        # Allowances
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/; style-src 'self' 'unsafe-inline' https://www.gstatic.com; font-src 'self' data:; img-src 'self' data: blob: https://http.cat https://www.gstatic.com; worker-src 'self' blob:; frame-src https://www.google.com/recaptcha/ https://recaptcha.google.com/recaptcha/; connect-src 'self' https://www.google.com https://www.gstatic.com;" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        location /api {
            limit_req zone=api_limit burst=10 nodelay;

            proxy_pass https://backend;
            proxy_ssl_verify on;
            proxy_ssl_trusted_certificate /etc/ssl/certs/step-root.pem;
            proxy_ssl_name server.healthsecure.local;
            proxy_ssl_server_name on;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        location /admin {
            proxy_pass https://backend;
            proxy_ssl_verify on;
            proxy_ssl_trusted_certificate /etc/ssl/certs/step-root.pem;
            proxy_ssl_name server.healthsecure.local;
            proxy_ssl_server_name on;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        location /static/ {
            alias /var/www/static/;
            expires 3d;
            access_log off;
            add_header Cache-Control "public";
        }

        location / {
            proxy_pass https://frontend;
            proxy_ssl_verify on;
            proxy_ssl_trusted_certificate /etc/ssl/certs/step-root.pem;
            proxy_ssl_name client.healthsecure.local;
            proxy_ssl_server_name on;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

services:
  step-ca:
    image: smallstep/step-ca:0.28.4
    container_name: step-ca
    restart: unless-stopped
    environment:
      STEP_CA_PASSWORD_FILE: /home/step/secrets/password
      STEPDEBUG: "0"
    volumes:
      - stepca-data:/home/step
    ports:
      - "9000-9001:9000-9001"
    healthcheck:
      test: ["CMD-SHELL", "step ca health --ca-url https://step-ca:9000 --root /home/step/certs/root_ca.crt 2>/dev/null | grep -q '^ok' || exit 1"]
      interval: 20s
      timeout: 15s
      retries: 5
      start_period: 55s

  db:
    image: postgres:17-alpine
    container_name: psqldb
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_DB: health
      POSTGRES_USER: health
      POSTGRES_PASSWORD: health
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U health -d health"]
      interval: 5s
      timeout: 5s
      retries: 10

  server:
    build: ./server
    container_name: server
    command: sh -c "mkdir -p /app/logs && touch /app/logs/app.log && mkdir -p /tls && step ca certificate server.healthsecure.local /tls/server.crt /tls/server.key --provisioner healthsecure-provisioner --provisioner-password-file /ca/secrets/password --ca-url https://step-ca:9000 --root /ca/certs/root_ca.crt --san server --san server.healthsecure.local --san localhost --san 127.0.0.1 --san ::1 --not-after 8760h && cat /tls/server.crt /ca/certs/intermediate_ca.crt > /tls/fullchain.crt && cat /ca/certs/intermediate_ca.crt /ca/certs/root_ca.crt > /tls/ca_chain.crt && uv run python manage.py migrate && uv run python manage.py collectstatic --noinput && uv run gunicorn --bind 0.0.0.0:8000 --certfile /tls/fullchain.crt --keyfile /tls/server.key --timeout 90 wsgi:application"
    volumes:
      - ./server:/app
      - stepca-data:/ca:ro
    env_file:
      - .env
    environment:
      STEP_CA_URL: https://step-ca:9000
      STEP_ROOT: /ca/certs/root_ca.crt
      STEP_INTERMEDIATE: /ca/certs/intermediate_ca.crt
      STEP_PROVISIONER: healthsecure-provisioner
      STEP_PASSWORD_FILE: /ca/secrets/password
    depends_on:
      db:
        condition: service_healthy
      step-ca:
        condition: service_healthy
    expose:
      - "8000"

  client:
    build: ./client
    container_name: client
    volumes:
      - ./client:/app
      - /app/node_modules
      - ./pki/leafs/client/fullchain.crt:/tls/client.crt:ro
      - ./pki/leafs/client/client.key:/tls/client.key:ro
    command: pnpm dev --host
    env_file:
      - .env
    environment:
      - CI=true
      - NODE_ENV=development
      - VITE_RP_ID=healthsecure.local
      - TLS_CERT_PATH=/tls/client.crt
      - TLS_KEY_PATH=/tls/client.key
    depends_on:
      - server
    expose:
      - "5173"
    extra_hosts:
      - "healthsecure.local:127.0.0.1"
      - "client.healthsecure.local:127.0.0.1"

  logger:
    build: ./logger
    container_name: logger
    volumes:
      - ./pki/leafs/logger:/certs:ro
      - logger_data:/data
      - ./pki/roots/ca_chain.crt:/tls/ca_chain.crt:ro
    environment:
      - LOGGER_SIGNING_PRIVATE_KEY=qPF5+8zdvNKwcGtr/q2zqWNMMZ/d28waCgOfQZmBf9U=
    expose:
      - "5001"
    depends_on:
      - server
  
  nginx:
    image: nginx:1.29-alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "3443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/snippets/upstream_headers.conf:/etc/nginx/snippets/upstream_headers.conf:ro
      - ./pki/leafs/nginx/fullchain.crt:/etc/ssl/certs/ssl-chain.pem:ro
      - ./pki/leafs/nginx/nginx.key:/etc/ssl/private/ssl-privatekey.pem:ro
      - ./pki/roots/step-root.pem:/etc/ssl/certs/step-root.pem:ro
      - ./server/staticfiles:/var/www/static:ro
    depends_on:
      - client
      - server

volumes:
  postgres_data:
  stepca-data:
    external: true
  logger_data:
